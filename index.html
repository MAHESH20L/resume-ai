<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Resume Maker Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 0 20px 40px 20px;
      background: linear-gradient(135deg, #eef2f3, #8e9eab);
      color: #222;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
      color: #222;
      text-shadow: 1px 1px 2px #fff;
    }
    #chatContainer {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-message {
      max-width: 70%;
      padding: 12px 18px;
      border-radius: 20px;
      font-size: 16px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }
    .chat-bot {
      background-color: #dbeeff;
      align-self: flex-start;
      color: #222;
      border: 1px solid #aac9ff;
    }
    .chat-user {
      background-color: #007bff;
      align-self: flex-end;
      color: white;
      border: 1px solid #0056b3;
    }
    /* Pencil edit button */
    .edit-btn {
      position: absolute;
      bottom: 6px;
      right: 10px;
      font-size: 16px;
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      padding: 0;
    }
    .edit-btn:hover {
      color: #0056b3;
    }
    #inputSection {
      display: flex;
      margin-top: 20px;
      gap: 10px;
    }
    #answerInput {
      flex-grow: 1;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #bbb;
      resize: none;
      height: 60px;
      transition: border-color 0.3s;
    }
    #answerInput:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    #nextButton {
      padding: 0 20px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,123,255,0.4);
      transition: background-color 0.3s ease;
      min-width: 120px;
    }
    #nextButton:hover:not(:disabled) {
      background-color: #0056b3;
    }
    #nextButton:disabled {
      background-color: #999;
      cursor: not-allowed;
      box-shadow: none;
    }
    .error {
      color: red;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
      height: 1.5em;
    }
    #output {
      margin-top: 20px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      font-family: 'Calibri', 'Arial', sans-serif;
      font-size: 11pt;
      line-height: 1.6;
      color: #333333;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      padding: 10px 30px 30px 30px;
      display: none;
    }
    /* Resume PDF style */
    .header {
      background-color: #e8e4f3;
      padding: 20px 40px;
      text-align: center;
      margin-bottom: 20px;
    }
    .header h1 {
      font-size: 32pt;
      font-weight: 300;
      letter-spacing: 8px;
      margin: 0;
      color: #333333;
    }
    .contact {
      text-align: center;
      font-size: 10pt;
      margin-top: 10px;
      color: #666666;
    }
    .contact a {
      color: #7c5ce0;
      text-decoration: none;
    }
    .summary {
      padding: 0 40px;
      margin-bottom: 20px;
      text-align: justify;
      color: #555555;
      line-height: 1.5;
    }
    h2 {
      font-size: 14pt;
      font-weight: bold;
      color: #333333;
      margin: 20px 0 10px 40px;
      padding: 0;
    }
    .content {
      padding: 0 40px;
      margin-bottom: 15px;
    }
    ul {
      list-style-type: disc;
      padding-left: 60px;
      margin: 5px 0;
    }
    li {
      margin-bottom: 8px;
      line-height: 1.4;
    }
    strong {
      font-weight: bold;
      color: #333333;
    }
    .project-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    a {
      color: #0000EE;
      text-decoration: underline;
    }
    a:hover {
      color: #551A8B;
    }
    .education-item {
      margin-bottom: 5px;
    }
    .section-spacing {
      margin-bottom: 15px;
    }
    .text-justify {
      text-align: justify;
    }
    #downloadBtn {
      margin: 15px auto 0 auto;
      display: none;
      background-color: #28a745;
      padding: 12px 25px;
      font-weight: bold;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(40,167,69,0.4);
    }
    #downloadBtn:hover {
      background-color: #19692c;
    }
  </style>
</head>
<body>
  <h1>Welcome to AI Resume Maker</h1>

  <div id="chatContainer"></div>

  <div id="inputSection">
    <textarea id="answerInput" placeholder="Type your answer..."></textarea>
    <button id="nextButton">Next</button>
  </div>

  <div class="error" id="errorMessage"></div>
  <div id="output"></div>
  <button id="downloadBtn">Download Word Resume</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    const apiKey = "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";

    const questionsList = [
      { key: "jobRole", question: "What job role do you want to prepare your resume for?", placeholder: "e.g., Software Developer" },
      { key: "name", question: "What is your full name?", placeholder: "Your full name" },
      { key: "address", question: "[Your Address]", placeholder: "", optional: true },
      { key: "cityStateZip", question: "[City, State, ZIP]", placeholder: "", optional: true },
      { key: "email", question: "[Your Email]", placeholder: "example@mail.com", optional: true },
      { key: "phone", question: "[Your Phone Number]", placeholder: "", optional: true },
      { key: "profile", question: "[LinkedIn Profile / GitHub Profile]", placeholder: "LinkedIn or GitHub URL", optional: true },

      // Education detailed fields
      { key: "edu_university", question: "Education - University name?" },
      { key: "edu_cityState", question: "Education - City and State of University?" },
      { key: "edu_gradDate", question: "Education - Month and Year of Graduation?" },

      { key: "certifications", question: "List your certifications (or say 'No' if none)", placeholder: "Certification names", optional: true },
      { key: "affiliations", question: "List professional affiliations (or say 'No' if none)", placeholder: "Organizations, memberships", optional: true },
      { key: "skills", question: "What are your key skills?", placeholder: "Programming, tools, soft skills" },
      { key: "objective", question: "What is your career objective?", placeholder: "Brief career goal" },
      { key: "workDone", question: "What have you done (projects, work experience)?", placeholder: "Details about work/projects" },
      { key: "activities", question: "What other activities or accomplishments do you want to mention?", placeholder: "", optional: true }
    ];

    const chatContainer = document.getElementById('chatContainer');
    const answerInput = document.getElementById('answerInput');
    const nextButton = document.getElementById('nextButton');
    const errorDiv = document.getElementById('errorMessage');
    const outputDiv = document.getElementById('output');
    const downloadBtn = document.getElementById('downloadBtn');

    let answers = {};
    let currentQuestionIndex = 0;
    let editingIndex = null;

    function addChatMessage(text, sender, editable = false, questionIndex = null) {
      const message = document.createElement('div');
      message.classList.add('chat-message', sender === 'bot' ? 'chat-bot' : 'chat-user');
      message.textContent = text;

      if (editable && questionIndex !== null) {
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '✏️';
        editBtn.className = 'edit-btn';
        editBtn.title = 'Edit your answer';
        editBtn.onclick = () => editAnswer(questionIndex);
        message.style.position = 'relative';
        message.appendChild(editBtn);
      }

      chatContainer.appendChild(message);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showQuestion(index) {
      errorDiv.textContent = "";
      const q = questionsList[index];
      addChatMessage(q.question, 'bot');
      answerInput.value = answers[q.key] || '';
      answerInput.placeholder = q.placeholder || "";
      answerInput.rows = (["workDone", "activities", "edu_university", "edu_cityState", "edu_gradDate"].includes(q.key) || q.key === "objective") ? 5 : 2;
      answerInput.focus();
      nextButton.textContent = (index === questionsList.length - 1) ? "Generate Resume" : "Next";
    }

    function editAnswer(index) {
      editingIndex = index;
      while(chatContainer.children.length > index * 2) {
        chatContainer.removeChild(chatContainer.lastChild);
      }
      currentQuestionIndex = index;
      showQuestion(currentQuestionIndex);
      answerInput.focus();
    }

    function validateAnswer(text) {
      return text.trim().length > 0;
    }

    function isNegativeAnswer(text) {
      if (!text) return false;
      const neg = text.toLowerCase().trim();
      return ["no", "nope", "none", "not applicable", "n/a", "na", "don't have", "do not have"].includes(neg);
    }

    function buildPrompt(answers) {
      let prompt = `Create a detailed, professional resume for a person with the following details:\n\n`;

      prompt += `Job Role: ${answers.jobRole}\n`;
      prompt += `Full Name: ${answers.name}\n`;

      const contactFields = ["address", "cityStateZip", "email", "phone", "profile"];
      let contactSection = "";
      contactFields.forEach(f => {
        if (answers[f] && !isNegativeAnswer(answers[f])) {
          contactSection += answers[f] + "\n";
        }
      });
      if (contactSection) prompt += `Contact Details:\n${contactSection}\n`;

      // Include Education only if none negative
      if (!(isNegativeAnswer(answers.edu_university) ||
            isNegativeAnswer(answers.edu_cityState) ||
            isNegativeAnswer(answers.edu_gradDate))) {
        prompt += `Education Background:\nUniversity: ${answers.edu_university}\nCity, State: ${answers.edu_cityState}\nGraduation: ${answers.edu_gradDate}\n\n`;
      }

      if (answers.certifications && !isNegativeAnswer(answers.certifications))
        prompt += `Certifications: ${answers.certifications}\n`;

      if (answers.affiliations && !isNegativeAnswer(answers.affiliations))
        prompt += `Professional Affiliations: ${answers.affiliations}\n`;

      prompt += `Skills: ${answers.skills}\n`;
      prompt += `Career Objective: ${answers.objective}\n`;
      prompt += `Work Experience / Projects: ${isNegativeAnswer(answers.workDone)? '' : answers.workDone}\n`;

      if (answers.activities && !isNegativeAnswer(answers.activities))
        prompt += `Other Activities / Achievements: ${answers.activities}\n`;

      prompt += `\nMake the resume well-structured with headings underlined and bolded, suitable for a professional Word document.`;

      return prompt;
    }

    function cleanResumeText(text) {
      return text
        .replace(/\*\*/g, '')    // remove double asterisks
        .replace(/\*/g, '')      // remove single asterisks
        .replace(/`/g, '')       // remove backticks
        .replace(/[_~]/g, '')    // remove underscores or tildes
        .trim();
    }

    async function generateResume() {
      errorDiv.textContent = "";
      nextButton.disabled = true;
      nextButton.textContent = "Generating...";
      downloadBtn.style.display = "none";

      try {
        const prompt = buildPrompt(answers);
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey,
          },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [
              { role: "system", content: "You are a professional resume writer." },
              { role: "user", content: prompt }
            ],
            max_tokens: 700
          })
        });

        if (!response.ok) {
          throw new Error("API error: " + response.statusText);
        }

        const data = await response.json();
        let resume = data.choices?.[0]?.message?.content || "No resume generated.";
        resume = cleanResumeText(resume);

        outputDiv.style.display = "block";
        outputDiv.innerHTML = styleResumeOutput(resume);
        questionContainer.style.display = "none";

        addChatMessage("Here is your generated resume:", "bot");

        downloadBtn.style.display = "inline-block";
        downloadBtn.onclick = () => {
          downloadWordDoc(resume);
        };

      } catch (error) {
        errorDiv.textContent = error.message;
      } finally {
        nextButton.disabled = false;
        nextButton.textContent = "Generate Resume";
      }
    }

    // Style resume output with your CSS embedded in innerHTML
    function styleResumeOutput(resumeText) {
      // Basic headings parsing and wrapping for demo
      const lines = resumeText.split('\n');
      let html = `<div class="header"><h1>${answers.name || "Name"}</h1></div>`;
      html += `<div class="contact">`;

      // Append contact if available
      if (!isNegativeAnswer(answers.address)) html += `<div>${answers.address}</div>`;
      if (!isNegativeAnswer(answers.cityStateZip)) html += `<div>${answers.cityStateZip}</div>`;
      if (!isNegativeAnswer(answers.email)) html += `<div>${answers.email}</div>`;
      if (!isNegativeAnswer(answers.phone)) html += `<div>${answers.phone}</div>`;
      if (!isNegativeAnswer(answers.profile)) html += `<div><a href="${answers.profile}">${answers.profile}</a></div>`;

      html += `</div>`;

      lines.forEach(line => {
        if (/^(Education Background|Certifications|Professional Affiliations|Skills|Career Objective|Work Experience|Other Activities)/i.test(line)) {
          html += `<h2>${line.trim()}</h2>`;
        } else if (line.trim()) {
          html += `<div class="content">${line.trim()}</div>`;
        }
      });
      return html;
    }

    // Download word doc with styling
    function downloadWordDoc(resumeText) {
      const cleanText = cleanResumeText(resumeText);
      let html = `
      <html><head><meta charset="UTF-8"><title>Resume</title>
      <style>
        body {
          font-family: 'Calibri', 'Arial', sans-serif;
          font-size: 11pt;
          line-height: 1.6;
          color: #333333;
          background-color: #ffffff;
          margin: 0;
          padding: 0;
        }
        .header {
          background-color: #e8e4f3;
          padding: 20px 40px;
          text-align: center;
          margin-bottom: 20px;
        }
        .header h1 {
          font-size: 32pt;
          font-weight: 300;
          letter-spacing: 8px;
          margin: 0;
          color: #333333;
        }
        .contact {
          text-align: center;
          font-size: 10pt;
          margin-top: 10px;
          color: #666666;
        }
        .contact a {
          color: #7c5ce0;
          text-decoration: none;
        }
        .summary {
          padding: 0 40px;
          margin-bottom: 20px;
          text-align: justify;
          color: #555555;
          line-height: 1.5;
        }
        h2 {
          font-size: 14pt;
          font-weight: bold;
          color: #333333;
          margin: 20px 0 10px 40px;
          padding: 0;
        }
        .content {
          padding: 0 40px;
          margin-bottom: 15px;
        }
        ul {
          list-style-type: disc;
          padding-left: 60px;
          margin: 5px 0;
        }
        li {
          margin-bottom: 8px;
          line-height: 1.4;
        }
        strong {
          font-weight: bold;
          color: #333333;
        }
        .project-title {
          font-weight: bold;
          margin-bottom: 5px;
        }
        a {
          color: #0000EE;
          text-decoration: underline;
        }
        a:hover {
          color: #551A8B;
        }
        .education-item {
          margin-bottom: 5px;
        }
        .section-spacing {
          margin-bottom: 15px;
        }
        .text-justify {
          text-align: justify;
        }
      </style>
      </head><body>`;

      // Simple heading detection and block wrap
      cleanText.split('\n').forEach(line => {
        if (line.trim().endsWith(":")) {
          html += `<h2>${line.trim().slice(0,-1)}</h2>`;
        } else if (line.trim() === '') {
          html += `<br/>`;
        } else {
          html += `<div class="content">${line.trim()}</div>`;
        }
      });

      html += `</body></html>`;

      const blob = new Blob([html], { type: "application/msword" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${answers.name ? answers.name.replace(/\s/g, "_") : "Resume"}.doc`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    nextButton.addEventListener("click", () => {
      const answer = answerInput.value.trim();
      if (!validateAnswer(answer)) {
        errorDiv.textContent = "Please provide an answer to continue.";
        return;
      }
      errorDiv.textContent = "";

      if (editingIndex !== null) {
        answers[questionsList[editingIndex].key] = answer;
        editingIndex = null;
        while(chatContainer.children.length > (currentQuestionIndex * 2)) {
          chatContainer.removeChild(chatContainer.lastChild);
        }
        addChatMessage(answer, 'user', true, currentQuestionIndex);
        currentQuestionIndex++;
        if (currentQuestionIndex >= questionsList.length) {
          generateResume();
          nextButton.disabled = true;
          nextButton.textContent = "Generating...";
        } else {
          showQuestion(currentQuestionIndex);
          nextButton.textContent = currentQuestionIndex === questionsList.length - 1 ? "Generate Resume" : "Next";
        }
        return;
      }

      answers[questionsList[currentQuestionIndex].key] = answer;
      addChatMessage(questionsList[currentQuestionIndex].question, 'bot');
      addChatMessage(answer, 'user', true, currentQuestionIndex);

      currentQuestionIndex++;
      if (currentQuestionIndex >= questionsList.length) {
        generateResume();
        nextButton.disabled = true;
        nextButton.textContent = "Generating...";
      } else {
        showQuestion(currentQuestionIndex);
        answerInput.value = "";
        nextButton.textContent = currentQuestionIndex === questionsList.length - 1 ? "Generate Resume" : "Next";
      }
    });

    window.onload = () => {
      showQuestion(0);
    };
  </script>
</body>
</html>
